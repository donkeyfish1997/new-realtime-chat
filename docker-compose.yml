# 使用其他網域時：在 .env 設定 NEXT_PUBLIC_SOCKET_URL 與 SOCKET_CORS_ORIGIN 為該網址（如 https://chat.example.com），再 docker compose up --build
services:
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./nginx/certbot-webroot:/var/www/certbot:ro
    depends_on:
      - app
      - socket

  app:
    build:
      context: .
      args:
        # 前端連 Socket 的網址，換網域時必設（會寫進 build，改動後需 --build）
        - NEXT_PUBLIC_SOCKET_URL=${NEXT_PUBLIC_SOCKET_URL:-http://localhost}
    command: npm run start
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_FIREBASE_API_KEY=${NEXT_PUBLIC_FIREBASE_API_KEY}
      - NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=${NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN}
      - NEXT_PUBLIC_FIREBASE_PROJECT_ID=${NEXT_PUBLIC_FIREBASE_PROJECT_ID}
      - NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=${NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET}
      - NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=${NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID}
      - NEXT_PUBLIC_FIREBASE_APP_ID=${NEXT_PUBLIC_FIREBASE_APP_ID}
      - FIREBASE_SERVICE_ACCOUNT=${FIREBASE_SERVICE_ACCOUNT}
      - SOCKET_SERVER_URL=http://socket:3001
      - SOCKET_EMIT_SECRET=${SOCKET_EMIT_SECRET}

  socket:
    build: .
    command: npx tsx socket-server/server.ts
    # 不對外暴露 port，僅由 Nginx 轉發 /socket.io/
    environment:
      - NODE_ENV=production
      - SOCKET_PORT=3001
      # 允許的來源網址，換網域時設成與 NEXT_PUBLIC_SOCKET_URL 一致（如 https://chat.example.com）
      - SOCKET_CORS_ORIGIN=${SOCKET_CORS_ORIGIN:-http://localhost}
      - FIREBASE_SERVICE_ACCOUNT=${FIREBASE_SERVICE_ACCOUNT}
      - SOCKET_EMIT_SECRET=${SOCKET_EMIT_SECRET}
